# In this second module, we will go from bins to metagenome-assembled genomes (MAGs)

Metagenomic bins are groups of genomic fragments (contigs). Some of these are microbial genomes, some of these might be viral genomes, and some to these are just fragmetns of one or multiple genomes. The idea is then to evaluate the complenetess and the contamination of those bins to evaluate their quality and only consider as genomes those are are >50% complete and <10% contaminated (although common in the literature, a more conservative threshold may be preferable).

So how do we estimated completeness and contamination? The idea is to use universal single-copy marker genes. These genes have the desirable behaviour of being expected in all bacterial and/or archaeal genomes, but only once. If you want to read more about those, here are a few papers:
- https://www.science.org/doi/10.1126/science.1123061
- https://www.nature.com/articles/nmeth.2575
- https://genome.cshlp.org/content/25/7/1043.short
- https://journals.asm.org/doi/abs/10.1128/msystems.00731-19 

To estimate genome completeness and contimation you have several options, including [CheckM](https://github.com/Ecogenomics/CheckM), Anvi'o or BUSCO. Here, we will use CheckM.

### Running commands in the background with `screen`

Running some bioinformatics tools can take time and we cannot always maintain the ssh connection open until they finish. To solve that issue, we can run tasks in so called `screens` that can run in the background and that we can check hours or even days later. 

To know more about those, you can have a look [here](). In the meantime you can:
- Create a screen for module-2 using the command `screen -S module-2`. This will start a new bash session.
- You can detach this bash session by click simultaneously on `ctrl+a` then `d`.
- Now any command in the screen `module-2` would be running in the background.
- You can resume the screen by simply typing `screen -r module-2`

To get started, in the screen session, activate the environment from module-2, move to the right directory (the module-2 directory) and link the bins folder to this new directory.

<details>
<summary><i>Click to display the command lines</I></summary>

  ```
  conda deactivate module-1
  conda activate module-2
  cd ~/metagenomics-workshop/module-2
  ln -s ~/metagenomics-workshop/module-1/ACIN21-1_SAMN05422137_METAG-bins .
  ```

</details>

### Evaluate the quality of the bins with CheckM

Let's start by displaying the help page of CheckM lineage workflow.

<details>
<summary><i>Click to display the command lines</I></summary>

  ```
  checkm
  checkm lineage_wf --help
  ```
  
  Small tip: if you want to scroll back up within a `screen` session, you can press simultaneously `ctrl+a` and then `esc`. You can get back to the normal features of the screen by pressing `esc` once more.

</details>

Now run CheckM with 6 threads and make sure it outputs a summary table. Notes that running CheckM will take some time.

<details>
<summary><i>Click to display the CheckM command</I></summary>
  
  ```
  mkdir ACIN21-1_SAMN05422137_METAG-checkm-tmp # useful to control the location of temporary files generated by checkM
  checkm lineage_wf -x fa ACIN21-1_SAMN05422137_METAG-bins/ ACIN21-1_SAMN05422137_METAG-checkm/ --tmpdir ACIN21-1_SAMN05422137_METAG-checkm-tmp/ --threads 6 -f ACIN21-1_SAMN05422195_METAG-checkm.tsv --tab_table
  ```

</details>

### Taxonomic classification of metagenomic bins using GTDBtk

For a more accurate taxonomic classification, we can turn to GTDBtk.

Prompt the help message of `gtdbtk` and try to run the `classify_wf` with 6 threas (`cpus`).

<details>
<summary><i>Click to display the CheckM command</I></summary>
  
  ```
  gtdbtk classify_wf --genome_dir ACIN21-1_SAMN05422137_METAG-bins/ --out_dir ACIN21-1_SAMN05422137_METAG-gtdb/ --extension fa --cpus 6
  ```

</details>
